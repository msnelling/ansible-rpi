---
- name: Init | get the MAC address
  set_fact:
    mac_address: "{{ hostvars[inventory_hostname].ansible_default_ipv4.macaddress | regex_replace(':', '-') }}"

- name: Init | get the MAC mappings
  set_fact:
    hostname: "{{ mac_mapping[mac_address].hostname }}"

- name: Init | set the hostname
  hostname:
    name: "{{ hostname }}"
  register: set_hostname
  tags: hostname

- name: Init | add myself to /etc/hosts
  lineinfile:
    dest: /etc/hosts
    regexp: '^127\.0\.1\.1[ \t]+'
    line: "127.0.1.1\t{{ hostname }}"
    state: present
  tags: hostname

- name: Init | reboot the system
  include_tasks: reboot.yml
  when: set_hostname.changed
  tags: hostname

- name: Init | add the Ansible user
  user:
    name: "{{ provisioning_username }}"
    shell: /bin/bash
    append: yes
    password: "{{ provisioning_password | password_hash( 'sha512', 65534 | random(seed=inventory_hostname) | string ) }}"